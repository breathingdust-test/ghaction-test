name: IYHAC
on:
  pull_request:
    types: [opened, ready_for_review, labeled]
jobs:
  check-maintainer:
    env:
      TEAM_SLUG: test
    if: >
      (github.event.action == 'opened' && !github.event.pull_request.draft) ||
      (github.event.action == 'ready_for_review') ||
      (github.event.action == 'labeled' && github.event.label.name == 'in-review' && !github.event.pull_request.draft)
    runs-on: ubuntu-latest
    steps:
      - name: Check if author is maintainer
        id: check-maintainer
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          TEAM_MEMBERS=$(gh api /orgs/${{ github.repository_owner }}/teams/$TEAM_SLUG/members --jq '.[].login')

          if echo "$TEAM_MEMBERS" | grep -q "^$AUTHOR$"; then
            echo "is_maintainer=true" >> $GITHUB_OUTPUT
          else
            echo "is_maintainer=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Check if terraform-aws member assigned
        id: check-assigned
        run: |
          REVIEWERS='${{ toJson(github.event.pull_request.requested_reviewers) }}'

          TEAM_MEMBERS=$(gh api /orgs/${{ github.repository_owner }}/teams/$TEAM_SLUG/members --jq '.[].login')

          HAS_MAINTAINER=false
          if [ "$REVIEWERS" != "[]" ]; then
            for reviewer in $(echo "$REVIEWERS" | jq -r '.[]'); do
              echo "Checking reviewer: $reviewer"
              if echo "$TEAM_MEMBERS" | grep -q "^$reviewer$"; then
                HAS_MAINTAINER=true
                break
              fi
            done
          fi

          echo "has_maintainer_reviewer=$HAS_MAINTAINER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Assign reviewer
        if: >
          steps.check-assigned.outputs.has_maintainer_reviewer == 'false' &&
          (steps.check-maintainer.outputs.is_maintainer == 'true' || contains(github.event.pull_request.labels.*.name, 'in-review'))
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}

          script: |
            // excluded as they are not part of the reviewer rotation.
            const excluded = ['justinretzolk'];
            const author = context.payload.pull_request.user.login;

            const { data: members } = await github.rest.teams.listMembersInOrg({
              org: context.repo.owner,
              team_slug: process.env.TEAM_SLUG
            });

            const eligible = members
              .map(m => m.login)
              .filter(login => login !== author && !excluded.includes(login))
              .sort();

            if (eligible.length === 0) return;

            // Count assignments in last 50 merged PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100,
              sort: 'updated',
              direction: 'desc'
            });

            const mergedPrs = prs.filter(pr => pr.merged_at !== null)
            .slice(0, 50);

            const counts = {};
            eligible.forEach(login => counts[login] = 0);

            for (const pr of mergedPrs) {
              for (const reviewer of pr.requested_reviewers || []) {
                if (counts.hasOwnProperty(reviewer.login)) {
                  counts[reviewer.login]++;
                }
              }
            }

            const reviewer = eligible.reduce((min, login) =>
              counts[login] < counts[min] ? login : min
            );

            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: [reviewer]
            });
      - id: should-message
        if: (steps.check-maintainer.outputs.is_maintainer == 'true' || github.event.action == 'labeled')
        run: echo "true" >> $GITHUB_OUTPUT
      - name: Send Slack notification
        if: steps.check-maintainer.outputs.is_maintainer == 'true' || github.event.action == 'labeled'
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if [ "${{ github.event.action }}" = "labeled" ]; then
            MAINTAINER="${{ github.event.sender.login }}"
            MESSAGE="$MAINTAINER has marked #$PR_NUMBER ($PR_TITLE) by contributor $AUTHOR as requiring review."
          else
            MESSAGE="@$AUTHOR has raised #$PR_NUMBER ($PR_TITLE) and requires review."
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MESSAGE\"}" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
