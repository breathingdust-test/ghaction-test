name: IYHAC
on:
  pull_request:
    types: [opened, ready_for_review, labeled]
jobs:
  check-maintainer:
    env:
      TEAM_SLUG: test
    if: >
      (github.event.action == 'opened' && !github.event.pull_request.draft) ||
      (github.event.action == 'ready_for_review') ||
      (github.event.action == 'labeled' && github.event.label.name == 'in-review' && !github.event.pull_request.draft)
    runs-on: ubuntu-latest
    steps:
      - name: Check if author is maintainer
        id: check-maintainer
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          TEAM_MEMBERS=$(gh api /orgs/${{ github.repository_owner }}/teams/$TEAM_SLUG/members --jq '.[].login')

          if echo "$TEAM_MEMBERS" | grep -q "^$AUTHOR$"; then
            echo "$AUTHOR is a maintainer"
            echo "is_maintainer=true" >> $GITHUB_OUTPUT
          else
            echo "$AUTHOR is not a maintainer"
            echo "is_maintainer=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Check if terraform-aws member assigned
        id: check-assigned
        run: |
          REVIEWERS='${{ toJson(github.event.pull_request.requested_reviewers) }}'

          TEAM_MEMBERS=$(gh api /orgs/${{ github.repository_owner }}/teams/$TEAM_SLUG/members --jq '.[].login')

          HAS_MAINTAINER=false
          if [ "$REVIEWERS" != "[]" ]; then
            for reviewer in $(echo "$REVIEWERS" | jq -r '.[].login'); do
              echo "Checking reviewer: $reviewer"
              if echo "$TEAM_MEMBERS" | grep -q "^$reviewer$"; then
                HAS_MAINTAINER=true
                break
              fi
            done
          fi
          echo "PR has maintainer reviewer: $HAS_MAINTAINER"
          echo "has_maintainer_reviewer=$HAS_MAINTAINER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - id: assign-reviewer
        if: >
          steps.check-assigned.outputs.has_maintainer_reviewer == 'false' &&
          (steps.check-maintainer.outputs.is_maintainer == 'true')
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          result-encoding: string
          script: |
            // excluded as they are not part of the reviewer rotation.
            const excluded = ['justinretzolk'];
            const author = context.payload.pull_request.user.login;

            const { data: members } = await github.rest.teams.listMembersInOrg({
              org: context.repo.owner,
              team_slug: process.env.TEAM_SLUG
            });

            const eligible = members
              .map(m => m.login)
              .filter(login => login !== author && !excluded.includes(login))
              .sort();

            if (eligible.length === 0) return;

            // Count assignments in last 50 merged PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100,
              sort: 'updated',
              direction: 'desc'
            });

            const mergedPrs = prs.filter(pr => pr.merged_at !== null)
            .slice(0, 50);

            const counts = {};
            eligible.forEach(login => counts[login] = 0);

            for (const pr of mergedPrs) {
              for (const reviewer of pr.requested_reviewers || []) {
                if (counts.hasOwnProperty(reviewer.login)) {
                  counts[reviewer.login]++;
                }
              }
            }

            const reviewer = eligible.reduce((min, login) =>
              counts[login] < counts[min] ? login : min
            );

            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: [reviewer]
            });
            return reviewer;
      - name: Send Slack notification for maintainer PR
        if: steps.check-maintainer.outputs.is_maintainer == 'true' && steps.assign-reviewer.outputs.result != ''
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "text": "${{ github.event.pull_request.user.login }} opened #${{ github.event.pull_request.number }} titled \"${{ github.event.pull_request.title }}\". Reviewer assigned.: ${{ steps.assign-reviewer.outputs.result }}",
              "channel": "${{ secrets.SLACK_CHANNEL }}",
              "unfurl_links": false,
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":pr: <https://github.com/${{ github.event.pull_request.user.login }}|${{ github.event.pull_request.user.login }}> opened <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}> titled \"${{ github.event.pull_request.title }}\". Reviewer assigned: <https://github.com/${{ steps.assign-reviewer.outputs.result }}|${{ steps.assign-reviewer.outputs.result }}>"
                  }
                }
              ]
            }
      - name: Send Slack notification for labeled PR
        if: github.event.action == 'labeled' && steps.assign-reviewer.outputs.result != ''
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL }}",
              "unfurl_links": false,
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":pr: <https://github.com/${{ github.event.sender.login }}|${{ github.event.sender.login }}> has marked <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}> titled \"${{ github.event.pull_request.title }}\" as requiring review. Reviewer assigned: <https://github.com/${{ steps.assign-reviewer.outputs.result }}|${{ steps.assign-reviewer.outputs.result }}>"
                  }
                }
              ]
            }
