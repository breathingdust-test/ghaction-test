name: IYHAC-ci
on:
    check_suite:
        types: [completed]

jobs:
    notify-slack:
        runs-on: ubuntu-latest
        if: github.event.check_suite.pull_requests[0] != null
        steps:
            - name: Get PR details
              id: pr
              uses: actions/github-script@v7
              with:
                  script: |
                      const pr = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.check_suite.pull_requests[0].number
                      });

                      const hasInReviewLabel = pr.data.labels.some(label => label.name === 'in-review');
                      const isInTeam = await github.rest.teams.getMembershipForUserInOrg({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        username: pr.data.user.login
                      }).then(() => true).catch(() => false);

                      const shouldNotify = hasInReviewLabel || isInTeam;

                      return {
                        shouldNotify,
                        prNumber: pr.data.number,
                        prTitle: pr.data.title,
                        prAuthor: pr.data.user.login,
                        prUrl: pr.data.html_url
                      };

            - name: Send Slack notification
              if: fromJSON(steps.pr.outputs.result).shouldNotify
              uses: 8398a7/action-slack@v3
              with:
                  status: ${{ github.event.check_suite.conclusion }}
                  text: |
                      Check suite ${{ github.event.check_suite.conclusion }} for PR #${{ fromJSON(steps.pr.outputs.result).prNumber }}
                      Title: ${{ fromJSON(steps.pr.outputs.result).prTitle }}
                      Author: ${{ fromJSON(steps.pr.outputs.result).prAuthor }}
                      URL: ${{ fromJSON(steps.pr.outputs.result).prUrl }}
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
