name: IYHAC-ci
on:
    status: # External CI (Jenkins, etc.)
    check_run: # GitHub Actions & Apps
        types: [completed]

jobs:
    gatekeeper:
        runs-on: ubuntu-latest
        # Prevent the action from running on its own status updates to avoid infinite loops
        if: github.event.check_run.name != 'IYHAC-ci'

        steps:
            - name: Check Overall PR Health
              uses: actions/github-script@v7
              id: health_check
              with:
                  script: |
                      const sha = context.payload.check_run?.head_sha || context.payload.sha;

                      // 1. Fetch the combined status (Commit Statuses)
                      const { data: combinedStatus } = await github.rest.repos.getCombinedStatusForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: sha,
                      });

                      // 2. Fetch all Check Runs (GitHub Actions)
                      const { data: checkRuns } = await github.rest.checks.listForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: sha,
                      });

                      const allCheckRunsSuccessful = checkRuns.check_runs.every(
                        run => run.conclusion === 'success' || run.name === 'Global Check Monitor'
                      );

                      console.log(`Combined Status State: ${combinedStatus.state}`);
                      console.log(`All Check Runs Successful: ${allCheckRunsSuccessful}`);

                      // Logic: Is everything finished and green?
                      if (combinedStatus.state === 'success' && allCheckRunsSuccessful) {
                        return true;
                      }
                      return false;

            - name: Final Automation
              if: steps.health_check.outputs.result == 'true'
              run: |
                  echo "All checks from all sources are officially GREEN."
                  # Insert your final deployment, notification, or merge logic here.
