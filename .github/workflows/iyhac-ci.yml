name: Monitor PR Health
on:
    pull_request:
        types: [opened, synchronize]

jobs:
    wait-for-checks:
        runs-on: ubuntu-latest
        steps:
            - name: Check PR eligibility
              id: check
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GH_TOKEN }}
                  script: |
                      const pr = context.payload.pull_request;
                      const hasInReviewLabel = pr.labels.some(label => label.name === 'in-review');

                      const isMaintainer = await github.rest.teams.getMembershipForUserInOrg({
                        org: context.repo.owner,
                        team_slug: 'test',
                        username: pr.user.login
                      }).then(() => true).catch(() => false);

                      const shouldRun = hasInReviewLabel || (isMaintainer && !pr.draft);
                      console.log(`PR eligible for monitoring: ${shouldRun}`);
                      core.setOutput('should_run', shouldRun);

            - name: Wait for status to turn green
              id: wait_status
              if: steps.check.outputs.should_run == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const maxAttempts = 12; // 12 * 10 seconds = 2 mins
                      const delay = 10000; 

                      for (let i = 0; i < maxAttempts; i++) {
                        const { data: checkRuns } = await github.rest.checks.listForRef({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          ref: context.payload.pull_request.head.sha,
                        });

                        const filteredRuns = checkRuns.check_runs.filter(run => run.name !== 'wait-for-checks');
                        const allCompleted = filteredRuns.every(run => run.status === 'completed');
                        const allSuccessful = filteredRuns.every(run => run.conclusion === 'success');

                        if (allCompleted) {
                          const status = allSuccessful ? 'success' : 'failed';
                          console.log(`All checks completed with status: ${status}`);
                          core.setOutput('status', status);
                          return;
                        }

                        console.log(`Checks status: ${filteredRuns.length} total, completed: ${filteredRuns.filter(r => r.status === 'completed').length}`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                      }

                      core.setOutput('status', 'failed');
                      throw new Error("Timed out waiting for checks to pass.");

            - name: Find Slack message
              id: slack_message
              if: steps.check.outputs.should_run == 'true'
              run: |
                  messages=""
                  cursor=""
                  
                  for i in {1..10}; do
                    url="https://slack.com/api/conversations.history?channel=${{ secrets.SLACK_CHANNEL_ID }}&limit=50"
                    if [[ -n "$cursor" ]]; then
                      url="${url}&cursor=${cursor}"
                    fi
                    
                    response=$(curl -s -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" "$url")
                    batch=$(echo "$response" | jq -r '.messages[]')
                    messages="${messages}${batch}"
                    
                    cursor=$(echo "$response" | jq -r '.response_metadata.next_cursor // empty')
                    [[ -z "$cursor" ]] && break
                  done
                  
                  ts=$(echo "$messages" | jq -r "select(.app_id == \"${{ secrets.SLACK_APP_ID }}\" and (.text | contains(\"#${{ github.event.pull_request.number }}\"))) | .ts" | head -1)
                  
                  echo "ts=$ts" >> $GITHUB_OUTPUT

            - name: Update Slack message with status
              if: steps.check.outputs.should_run == 'true' && steps.slack_message.outputs.ts != 'null'
              run: |
                  if [[ "${{ steps.wait_status.outputs.status }}" == "success" ]]; then
                    emoji="white_check_mark"
                  else
                    emoji="x"
                  fi

                  curl -s -X POST -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"channel\": \"${{ secrets.SLACK_CHANNEL_ID }}\", \"ts\": \"${{ steps.slack_message.outputs.ts }}\", \"name\": \"$emoji\"}" \
                    "https://slack.com/api/reactions.add"
