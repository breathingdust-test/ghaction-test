name: Monitor PR Health
on:
    pull_request:
        types: [opened, synchronize]

jobs:
    wait-for-checks:
        runs-on: ubuntu-latest
        steps:
            - name: Check PR eligibility
              id: check
              uses: actions/github-script@v7
              with:
                  script: |
                      const pr = context.payload.pull_request;
                      const hasInReviewLabel = pr.labels.some(label => label.name === 'in-review');

                      const isMaintainer = await github.rest.teams.getMembershipForUserInOrg({
                        org: context.repo.owner,
                        team_slug: 'test',
                        username: pr.user.login
                      }).then(() => true).catch(() => false);

                      const shouldRun = hasInReviewLabel || (isMaintainer && !pr.draft);
                      console.log(`PR eligible for monitoring: ${shouldRun}`);
                      core.setOutput('should_run', shouldRun);

            - name: Wait for status to turn green
              if: steps.check.outputs.should_run == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const maxAttempts = 12; // 12 * 10 seconds = 2 mins
                      const delay = 10000; 

                      for (let i = 0; i < maxAttempts; i++) {
                        const { data: status } = await github.rest.repos.getCombinedStatusForRef({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          ref: context.payload.pull_request.head.sha,
                        });

                        if (status.state === 'success') {
                          console.log("Checks passed!");
                          return true;
                        }

                        console.log(`Current state: ${status.state}. Waiting...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                      }
                      throw new Error("Timed out waiting for checks to pass.");
