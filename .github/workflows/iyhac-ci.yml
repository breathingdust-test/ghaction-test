name: IYHAC-ci
on: status
jobs:
  notify-slack:
    runs-on: ubuntu-latest
    if: github.event.commit
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.sha
            });
            
            if (prs.data.length === 0) return { shouldNotify: false };
            
            const pr = prs.data[0];
            const hasInReviewLabel = pr.labels.some(label => label.name === 'in-review');
            const isTerraformAwsTeam = await github.rest.teams.getMembershipForUserInOrg({
              org: 'hashicorp',
              team_slug: 'terraform-aws',
              username: pr.user.login
            }).then(() => true).catch(() => false);
            
            const shouldNotify = hasInReviewLabel || isTerraformAwsTeam;
            
            return {
              shouldNotify,
              prNumber: pr.number,
              prTitle: pr.title,
              prAuthor: pr.user.login,
              prUrl: pr.html_url
            };
      
      - name: Send Slack notification
        if: fromJSON(steps.pr.outputs.result).shouldNotify
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ github.event.state }}
          text: |
            Status ${{ github.event.state }} for PR #${{ fromJSON(steps.pr.outputs.result).prNumber }}
            Title: ${{ fromJSON(steps.pr.outputs.result).prTitle }}
            Author: ${{ fromJSON(steps.pr.outputs.result).prAuthor }}
            URL: ${{ fromJSON(steps.pr.outputs.result).prUrl }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
