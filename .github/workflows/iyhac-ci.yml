name: Monitor PR Health
on:
    pull_request:
        types: [opened, synchronize]

jobs:
    wait-for-checks:
        runs-on: ubuntu-latest
        steps:
            - name: Check PR eligibility
              id: check
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GH_TOKEN }}
                  script: |
                      const pr = context.payload.pull_request;
                      const hasInReviewLabel = pr.labels.some(label => label.name === 'in-review');

                      const isMaintainer = await github.rest.teams.getMembershipForUserInOrg({
                        org: context.repo.owner,
                        team_slug: 'test',
                        username: pr.user.login
                      }).then(() => true).catch(() => false);

                      const shouldRun = hasInReviewLabel || (isMaintainer && !pr.draft);
                      console.log(`PR eligible for monitoring: ${shouldRun}`);
                      core.setOutput('should_run', shouldRun);

            - name: Wait for status to turn green
              if: steps.check.outputs.should_run == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const maxAttempts = 12; // 12 * 10 seconds = 2 mins
                      const delay = 10000; 

                      for (let i = 0; i < maxAttempts; i++) {
                        const { data: checkRuns } = await github.rest.checks.listForRef({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          ref: context.payload.pull_request.head.sha,
                        });

                        const filteredRuns = checkRuns.check_runs.filter(run => run.name !== 'wait-for-checks');
                        const allCompleted = filteredRuns.every(run => run.status === 'completed');
                        const allSuccessful = filteredRuns.every(run => run.conclusion === 'success');

                        if (allCompleted && allSuccessful) {
                          console.log("All checks passed!");
                          return true;
                        }

                        console.log(`Checks status: ${filteredRuns.length} total, completed: ${filteredRuns.filter(r => r.status === 'completed').length}`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                      }
                      throw new Error("Timed out waiting for checks to pass.");
